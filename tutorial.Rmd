---
title: "QuIBL analysis tutorial"
author: "Nate Edelman"
date: "2/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is a tutorial for how to analyze output from the Quantifying Introgression via Branch Lengths software. For more details on QuIBL see <http://github.com/michaelmiyagi/QuIBL>.

First, we'll set up our environment. 
# ```{r quiblR}
# packages <- c("quiblR","ggplot2","ape","dplyr")
# lapply(packages, suppressMessages(library))
# ```

## Load the data

Now, we'll import the data generated by our QuIBL run. First, we'll just be thinking about the simple, 4-taxon case

```{r inputData}
speciesTree <- read_speciesTree("tutorial/heliconiusExample/speciesTree_fourTaxa.nwk")
quiblOutput <- read_csv_quibl("tutorial/heliconiusExample/fourTaxaOut.quibl")
originalTrees <- read.tree("tutorial/heliconiusExample/heliconius_5kTrees.nwk")
```

## Examine the data

What does our data look like? To understand this, let's take a look at what we've independently inferred to be the species tree.

```{r speciesTree}
plot(speciesTree)
```

Now, let's look at the QuIBL output

```{r viewOutput}
quiblOutput
```

To get familiar with our data, we'll walk through each column.

**triplet**

QuIBL examines each 3-species grouping in our data separately. But we have 4 species, so shouldn't there be (4 choose 3) = 4 different triplets? Why do we only have one (HeraRef_Hhsa_Htel)? This is because QuIBL assumes that we have a rooted tree, and in this case we have rooted our tree by fixing HmelRef as the outgroup. QuIBL discards all triplets that include the overall outgroup, since all loci are forced to have the same topology (HmelRef as the outgroup).

**outgroup**

The outgroup dictates the tree topology, as in three-taxon trees there is one outgroup and two ingroups. For example, when outgroup == HeraRef, the tree topology is (HeraRef,(Hhsa,Htel)).

**C1**

The internal branch length in the ILS only model. By definition, this is 0.

**C2**

The internal branch length in the two-ditribution model. If the topology is concordant with the species tree (In this case, when the outgroup is Htel, see the tree), C2 is the time between the two coalescence events. If this topology is discordant with the species tree, C2 is the time between the introgression event and the common ancestor of all three species.

**mixprop2**

Under the two-ditribution model, the proportion of loci that have a history of introgression 

**mixprop1**

Under the two-ditribution model, the proportion of loci that have a history of ILS 

**lambda2Dist**

The population size parameter (theta/2) under the two-ditribution model

**lambda1Dist**

The population size parameter (theta/2) under the ILS only model

**BIC2Dist**

The Bayesian Information Criteria for the fit of the data to the two-ditribution model

**BIC1Dist**

The Bayesian Information Criteria for the fit of the data to the ILS only model

*We only accept the two-distribution model if BIC2Dist is at least 10 units lower than BIC1Dist*

**count**

The number of loci that have this topology. 

## Get some big-picture results

In order to interpret the output, we'll do some simple transformaions and report out our top-line results. First, we need to know which of our topologies is concordant with the species tree, and which represent either ILS or introgression. We'll use the isSpeciesTree fuction from quiblR.

```{r assign species topology}
quiblOutput <- mutate(quiblOutput, isDiscordant=as.integer(! apply(quiblOutput, 1, isSpeciesTree, sTree=speciesTree)))
```

Next, we'll mark which of the topologies' 2-distribution model is a significantly better fit than the ILS only model, and if so we'll calculate the proportion of loci with a history of introgression for the full data for this triplet

```{r getSignificant}
quiblOutput <- mutate(quiblOutput, isSignificant = as.numeric(apply(quiblOutput, 1, testSignificance, threshold=10)))
totalTrees <- sum(quiblOutput$count)/length(unique(quiblOutput$triplet))
quiblOutput <- mutate(quiblOutput,totalIntrogressionFraction=(mixprop2*count*isDiscordant*isSignificant)/totalTrees)
quiblOutput
```

So, what have we learned? First, of all, looking just at the mixture proportions, we can see that QuIBL is detecting very little ILS in general. 



